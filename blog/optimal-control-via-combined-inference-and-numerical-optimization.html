<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Optimal Control via Combined Inference and Numerical Optimization</title>
<meta name="description" content="Thesis segment blog post"/>
<style>
  body {
    font-family: "Iowan Old Style", "Palatino Linotype", Palatino, "Times New Roman", serif;
    background: #f4f3ef;
    color: #202124;
    margin: 0;
  }

  .container {
    max-width: 880px;
    margin: 0 auto;
    padding: 18px 18px 34px;
  }

  a {
    color: #1f4e8c;
    text-decoration: none;
    border-bottom: 1px solid #b6c8e3;
  }

  a:hover {
    border-bottom-color: #1f4e8c;
  }

  .back {
    margin: 0 0 10px;
    font-size: 0.94rem;
  }

  .page-header {
    border-bottom: 1px solid #d9d7cf;
    padding-bottom: 12px;
    margin-bottom: 14px;
  }

  h1 {
    margin: 0;
    font-size: 2rem;
    line-height: 1.1;
    letter-spacing: -0.01em;
    color: #171717;
  }

  .meta {
    margin: 6px 0 0;
    color: #585d64;
    font-size: 0.95rem;
  }

  .section {
    border-bottom: 1px solid #e3e1d9;
    padding: 12px 0 14px;
  }

  .section:last-of-type {
    border-bottom: 0;
  }

  h2 {
    margin: 0 0 8px;
    font-size: 1.4rem;
    line-height: 1.2;
    color: #191919;
  }

  h3 {
    margin: 16px 0 7px;
    font-size: 1.12rem;
    line-height: 1.2;
    color: #1f1f1f;
  }

  p {
    margin: 0 0 8px;
    line-height: 1.5;
    font-size: 1rem;
  }

  ul {
    margin: 0 0 8px 20px;
    padding: 0;
  }

  li {
    margin: 3px 0;
  }

  .media-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 10px;
    margin: 8px 0;
  }

  .media-grid img,
  .single-image img {
    width: 100%;
    height: auto;
    display: block;
    border: 1px solid #ddd9ce;
    border-radius: 4px;
    background: #fff;
  }

  .single-image {
    margin: 8px 0;
  }

  .approach-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin: 8px 0;
  }

  .approach-col {
    border: 1px solid #dedcd3;
    background: #faf9f5;
    border-radius: 4px;
    padding: 8px 10px;
  }

  .approach-col h4 {
    margin: 0 0 6px;
    font-size: 1rem;
  }

  .equation {
    overflow-x: auto;
    margin: 8px 0;
    padding: 6px 8px;
    border-left: 2px solid #d3d0c6;
  }

  .result-video {
    width: 100%;
    border: 1px solid #d8d6ce;
    border-radius: 6px;
    background: #000;
    margin-top: 8px;
  }

  .conclusion-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    margin-top: 8px;
  }

  .conclusion-block {
    border: 1px solid #dedcd3;
    background: #faf9f5;
    border-radius: 4px;
    padding: 10px 12px;
  }

  .conclusion-block h4 {
    margin: 0 0 6px;
    font-size: 1.02rem;
    color: #1f1f1f;
  }

  .conclusion-block ul {
    margin: 0 0 0 18px;
  }

  .conclusion-block li {
    margin: 2px 0;
  }

  @media (max-width: 780px) {
    .container {
      padding: 14px 14px 22px;
    }

    h1 {
      font-size: 1.62rem;
    }

    .media-grid,
    .approach-grid {
      grid-template-columns: 1fr;
    }

    .conclusion-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
<script>
window.MathJax = {
  tex: {
    inlineMath: [['\\(', '\\)']],
    displayMath: [['\\[', '\\]']],
    macros: {
      vec: ['\\mathbf{#1}', 1]
    }
  },
  svg: { fontCache: 'global' }
};
</script>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>
  <main role="main">
    <div class="container">
      <p class="back"><a href="/blog/">&larr; Back to blog index</a></p>
      <header class="page-header">
        <h1>Optimal Control via Combined Inference and Numerical Optimization</h1>
        <p class="meta">Flexibility + Efficiency segment (ICRA 2022)</p>
      </header>

      <section class="section">
        <h2>Segment: Flexibility + Efficiency</h2>

        <h3>Problem statement</h3>
        <p>Numerical optimisation is efficient at refinement but fails to <strong>discover</strong> control policies or behaviours far from the point of initialisation. Sampling can discover further local optima through exploration with simpler cost functions.</p>
        <p><strong>Aim.</strong> Combine inference and second-order trajectory optimization so the method can <strong>efficiently sample</strong> when <em>no derivative information</em> is available and follow <strong>optimized trajectories</strong> when derivatives arise.</p>

        <h3>Numerical solution</h3>
        <p>The method relies on the Bellman equation and its tangent-space solution.</p>
        <div class="equation">
          \[
          v\left(\mathbf{x}, t\right) = \min_{\mathbf{u}}\left[\ell\left(\mathbf{x},\mathbf{u},t\right) + v\left(\mathbf{f}\left(\mathbf{x},\mathbf{u},t\right)\right)\right] \equiv Q\left(\mathbf{x},\mathbf{u},t\right)
          \]
        </div>
        <p>Solving in tangent space:</p>
        <div class="equation">
          \[
          Q\left(\delta\mathbf{x},\delta\mathbf{u}\right) \approx \frac{1}{2}
          \begin{bmatrix}1 \\ \delta\mathbf{x} \\ \delta\mathbf{u}\end{bmatrix}^{\!\top}
          \begin{bmatrix}
          0 & Q_{\mathbf{x}}^{\top} & Q_{\mathbf{u}}^{\top} \\
          Q_{\mathbf{x}} & Q_{\mathbf{xx}} & Q_{\mathbf{xu}} \\
          Q_{\mathbf{u}} & Q_{\mathbf{ux}} & Q_{\mathbf{uu}}
          \end{bmatrix}
          \begin{bmatrix}1 \\ \delta\mathbf{x} \\ \delta\mathbf{u}\end{bmatrix}
          \]
        </div>
        <p>Update law (Newton-like):</p>
        <div class="equation">
          \[
          \hat{\mathbf{u}} = \mathbf{u} - \left(Q_{\mathbf{u}} - Q_{\mathbf{ux}}\delta\mathbf{x}\right)Q^{-1}_{\mathbf{uu}}
          \]
        </div>

        <h3>Inference solution</h3>
        <p>The KL control approach is grounded in the stochastic version of the Bellman equation.</p>
        <div class="equation">
          \[
          \begin{aligned}
          \underset{\mathbf{u}}{\min}\left[\ell\left(\mathbf{x}\right) + &\,\mathrm{KL}(\mathbb{Q}\|\|\mathbb{P}) + \mathbb{E}_{\mathbb{Q}}\left[v\left(\mathbf{x}'\right)\right]\right]\\
          \mathrm{KL}(\mathbb{Q}\|\|\mathbb{P}) &= \mathbb{E}_{\mathbb{Q}}\!\left[\log\!\left(\frac{\mathbf{p}\left(\mathbf{x}'|\mathbf{x},\mathbf{u}\right)}{\mathbf{p}\left(\mathbf{x}'|\mathbf{x}\right)}\right)\right]
          \end{aligned}
          \]
        </div>
        <p>Where \(\mathbf{p}\left(\mathbf{x}'|\mathbf{x},\mathbf{u}\right)\) and \(\mathbf{p}\left(\mathbf{x}'|\mathbf{x}\right)\) are the controlled and uncontrolled transition probabilities.</p>
        <p>Optimal controls:</p>
        <div class="equation">
          \[
          \mathbf{p}^*\left(\mathbf{x}'|\mathbf{x},\mathbf{u}\right) = \mathbf{p}\left(\mathbf{x}'|\mathbf{x}\right)\exp\left(-v\left(\mathbf{x}'\right)\right)\eta^{-1}
          \]
        </div>

        <h3>Combining inference with second order method</h3>
        <p>Reformulate the stochastic Bellman objective and add a secondary divergence term to the tangent-space Bellman solution.</p>
        <div class="equation">
          \[
          \begin{aligned}
          \underset{\mathbf{u}}{\min}\left[l\left(\mathbf{x}\right) + (1-k)&\,\mathrm{KL}(\mathbb{Q}\|\|\mathbb{P}) + k\,\mathrm{KL}(\mathbb{Q}\|\|\mathbb{C}) + \mathbb{E}_{\mathbb{Q}}\left[v\left(\mathbf{x}'\right)\right]\right]\\
          \mathrm{KL}(\mathbb{Q}\|\|\mathbb{C}) &= \mathbb{E}_{\mathbb{Q}}\!\left[\log\!\left(\frac{\mathbf{p}\left(\mathbf{x}'|\mathbf{x},\mathbf{u}\right)}{\mathbf{p}\left(\mathbf{x}'|\mathbf{x},\mathbf{u}_{\mathrm{iLQG}}\right)}\right)\right]
          \end{aligned}
          \]
        </div>
        <p>Update law over trajectory distribution:</p>
        <div class="equation">
          \[
          \mathbf{q}^*\left(\mathbf{W}\right) = \mathbf{p}\left(\mathbf{W}\right)^{1-k}\mathbf{c}\left(\mathbf{W}\right)^{k}\exp\!\left(-\frac{1}{\lambda}S\left(\mathbf{W}\right)\right)\eta^{-1}
          \]
        </div>
        <div class="equation">
          \[
          \mathbf{p}\left(\mathbf{W}\right):\mathbf{w}_t\sim\mathcal{N}\left(0,\mathbf{\Sigma}\right),\quad
          \mathbf{q}\left(\mathbf{W}\right):\mathbf{w}_t\sim\mathcal{N}\left(\mathbf{u}_t,\mathbf{\Sigma}\right),\quad
          \mathbf{c}\left(\mathbf{W}\right):\mathbf{w}_t\sim\mathcal{N}\left(\mathbf{u}_{\mathrm{iLQG}_t},\mathbf{\Sigma}_{\mathrm{iLQG}}\right)
          \]
        </div>

        <h3>Importance sampling</h3>
        <p>We cannot directly sample from \(\mathbf{q}^*(\vec W)\), so we importance sample:</p>
        <div class="equation">
          \[
          \mathbf{u}^* = \int \mathbf{q}\left(\vec W\right)\,w\left(\vec W\right)\,v_t\,\mathrm{d}W
          \]
        </div>
        <p>Sample weights:</p>
        <div class="equation">
          \[
          w\left(\vec W\right) = \frac{1}{\eta}\exp\!\left(-\frac{1}{2\lambda}S\left(\vec W\right)
          + \sum_{t=0}^{T}k\,\left(\vec w_t-\mathbf{u}_{\mathrm{iLQG}_t}\right)^\top
          \mathbf{\Sigma}_{\mathrm{iLQG}_t}^{-1}\left(\vec w_t-\mathbf{u}_{\mathrm{iLQG}_t}\right)\right)
          \]
        </div>
        <p>iLQG distribution is obtained by maximizing \(\ln\exp\left(-\delta Q_t\left(\mathbf{x}_t,\mathbf{u}_t\right)\right)\), with samples from \(\mathbb{C}\) as \(\vec w_t\sim\mathcal{N}\left(\mathbf{u}_{\mathrm{iLQG}_t},Q^{-1}_{\mathbf{uu}_t}\right)\).</p>

        <h3>Results</h3>
        <video class="result-video" controls preload="metadata">
          <source src="value%20learning%20content/ICRA.mp4" type="video/mp4"/>
          Your browser does not support the video tag.
        </video>

        <h3>Conclusion</h3>
        <div class="conclusion-grid">
          <div class="conclusion-block">
            <h4>Contribution</h4>
            <ul>
              <li>Natural combination of inference and numerical optimisation.</li>
              <li>Inherent ability to explore.</li>
              <li>Combine convex and non-convex costs.</li>
            </ul>
          </div>
          <div class="conclusion-block">
            <h4>Caveats</h4>
            <ul>
              <li>Search across hyperparameters: \(\lambda\), \(\beta\), and \(k\).</li>
              <li>\(Q_{uu}^{-1}\) is not necessarily a good measure of confidence.</li>
              <li>Constant control input noise affects convergence.</li>
              <li>In the worst case, it can perform as badly as the other methods.</li>
            </ul>
          </div>
        </div>
      </section>
    </div>
  </main>
</body>
</html>
